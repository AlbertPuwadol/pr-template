name: Write Release Notes

on:
    # release:
    #     types: [published]
    workflow_call:
        inputs:
            release_tag:
                required: true
                type: string
            repository_name:
                required: true
                type: string
        secrets:
            PERSONAL_ACCESS_TOKEN:
                required: true
                description: "Personal access token for the repository"
            GOOGLE_SHEET_CLIENT_EMAIL:
                required: true
                description: "Google sheet client email"
            GOOGLE_SHEET_PRIVATE_KEY:
                required: true
                description: "Google sheet private key"
            GOOGLE_SHEET_ID:
                required: true
                description: "Google sheet ID"

jobs:
    get_release_notes:
        runs-on: ubuntu-latest
        steps:
            - name: Get Release Notes
              id: get_release
              run: |
                  RELEASE_TAG="${{ inputs.release_tag }}"
                  echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
                  RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
                    "https://api.github.com/repos/${{ inputs.repository_name }}/releases/tags/${RELEASE_TAG}")
                  RELEASE_BODY=$(echo "$RELEASE_INFO" | jq -r '.body')
                  echo "RELEASE_BODY<<EOF" >> $GITHUB_OUTPUT
                  echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
              env:
                  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            - name: Use Release Notes
              run: |
                  echo "The release notes are:"
                  echo "DETAILS<<EOF" >> $GITHUB_ENV
                  echo "${{ steps.get_release.outputs.RELEASE_BODY }}" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Format Release Notes for Google Sheet
              id: format_notes
              run: |
                  # Extract feature names and URLs from the Changes section
                  RELEASE_BODY="${{ env.DETAILS }}"

                  # Extract all feature names from ### [Feature Name](url) pattern
                  FEATURE_NAMES=$(echo "$RELEASE_BODY" | grep -oP '###\s*\[\K[^\]]+' | tr '\n' ',' | sed 's/,$//' || echo "")

                  # Extract all URLs from ### [Feature Name](url) pattern
                  FEATURE_URLS=$(echo "$RELEASE_BODY" | grep -oP '###\s*\[[^\]]+\]\(\K[^)]+' | tr '\n' '\n' || echo "")

                  # Extract the Changes section with markdown up to ---
                  # Remove ### headers but keep links and bullet points, trim extra whitespace
                  CHANGES_SECTION=$(echo "$RELEASE_BODY" | awk '/^## Changes/,tolower($0) ~ /release sheet url:/ {if (!/^## Changes/ && tolower($0) !~ /release sheet url:/) print}' | sed -E 's/^[[:space:]]*###[[:space:]]*\[([^]]+)\]\([^)]+\)[[:space:]]*$/\1/' | sed -E 's/^[[:space:]]*###[[:space:]]*//' | awk 'NF {p=1} p' | awk '{gsub(/^[ \t]+|[ \t]+$/, "")}1' | grep -v '^[[:space:]]*$' | awk '{if (NR>1 && !/^-/) print ""; print $0}' || echo "")

                  # Get repository name from github context and extract only repo name (remove org/)
                  FULL_REPO="${{ inputs.repository_name }}"
                  REPO_NAME="${FULL_REPO##*/}" 

                  # Build the formatted row data
                  # Column 1: current date in Bangkok timezone (mm/dd/yyyy)
                  COL1=$(TZ='Asia/Bangkok' date '+%m/%d/%Y')
                  # Column 2: comma-separated feature names
                  COL2="$FEATURE_NAMES"
                  # Column 3: repository name
                  COL3="$REPO_NAME"
                  # Column 4: release tag with hyperlink
                  RELEASE_URL="https://github.com/${{ inputs.repository_name }}/releases/tag/${{ env.RELEASE_TAG }}"
                  COL4=$(printf '=HYPERLINK("%s","%s")' "$RELEASE_URL" "${{ env.RELEASE_TAG }}")
                  # Column 5: data version
                  COL5=""
                  # Column 6: deploy status
                  COL6=""
                  # Column 7: changes section with markdown
                  COL7="$CHANGES_SECTION"
                  # Column 8: URLs (newline separated)
                  COL8="$FEATURE_URLS"

                  # Output as multiline variables
                  echo "COL1=$COL1" >> $GITHUB_OUTPUT
                  echo "COL2=$COL2" >> $GITHUB_OUTPUT
                  echo "COL3=$COL3" >> $GITHUB_OUTPUT
                  echo "COL4<<EOF" >> $GITHUB_OUTPUT
                  echo "$COL4" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "COL5=$COL5" >> $GITHUB_OUTPUT
                  echo "COL6=$COL6" >> $GITHUB_OUTPUT
                  echo "COL7<<EOF" >> $GITHUB_OUTPUT
                  echo "$COL7" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "COL8<<EOF" >> $GITHUB_OUTPUT
                  echo "$COL8" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Prepare JSON command
              id: prepare_json
              env:
                  COL1: ${{ steps.format_notes.outputs.COL1 }}
                  COL2: ${{ steps.format_notes.outputs.COL2 }}
                  COL3: ${{ steps.format_notes.outputs.COL3 }}
                  COL4: ${{ steps.format_notes.outputs.COL4 }}
                  COL5: ${{ steps.format_notes.outputs.COL5 }}
                  COL6: ${{ steps.format_notes.outputs.COL6 }}
                  COL7: ${{ steps.format_notes.outputs.COL7 }}
                  COL8: ${{ steps.format_notes.outputs.COL8 }}
              run: |
                  COMMANDS=$(jq -n \
                  --arg col1 "$COL1" \
                  --arg col2 "$COL2" \
                  --arg col3 "$COL3" \
                  --arg col4 "$COL4" \
                  --arg col5 "$COL5" \
                  --arg col6 "$COL6" \
                  --arg col7 "$COL7" \
                  --arg col8 "$COL8" \
                  '[{"command": "appendData", "args": {"data": [[$col1, $col2, $col3, $col4, $col5, $col6, $col7, $col8]], "worksheetTitle": "Feature", "minCol": 1, "valueInputOption": "USER_ENTERED"}}]')
                  echo "COMMANDS<<EOF" >> $GITHUB_OUTPUT
                  echo "$COMMANDS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Update Google Sheet
              uses: jroehl/gsheet.action@v2.1.1
              with:
                  spreadsheetId: ${{ secrets.GOOGLE_SHEET_ID }}
                  commands: ${{ steps.prepare_json.outputs.COMMANDS }}
              env:
                  GSHEET_CLIENT_EMAIL: ${{ secrets.GOOGLE_SHEET_CLIENT_EMAIL }}
                  GSHEET_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEET_PRIVATE_KEY }}
