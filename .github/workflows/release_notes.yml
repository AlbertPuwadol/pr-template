name: Write Release Notes

on:
    release:
        types: [published]

jobs:
    get_release_notes:
        runs-on: ubuntu-latest
        steps:
            - name: Get Release Notes
              id: get_release
              run: |
                  RELEASE_TAG="${{ github.ref_name }}"
                  echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
                  RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
                    "https://api.github.com/repos/${{ github.repository }}/releases/tags/${RELEASE_TAG}")
                  RELEASE_BODY=$(echo "$RELEASE_INFO" | jq -r '.body')
                  echo "RELEASE_BODY<<EOF" >> $GITHUB_OUTPUT
                  echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
              env:
                  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            - name: Use Release Notes
              run: |
                  echo "The release notes are:"
                  echo "DETAILS<<EOF" >> $GITHUB_ENV
                  echo "${{ steps.get_release.outputs.RELEASE_BODY }}" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Prepare JSON command
              id: prepare_json
              run: |
                  COMMANDS=$(jq -n \
                  --arg details "${{ env.DETAILS }}" \
                  '[{"command": "appendData", "args": {"data": [[$details]], "worksheetTitle": "Test-v1.5.0", "minCol": 1}}]')
                  echo "COMMANDS<<EOF" >> $GITHUB_OUTPUT
                  echo "$COMMANDS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Update Google Sheet
              uses: jroehl/gsheet.action@v2.1.1
              with:
                  spreadsheetId: ${{ secrets.GOOGLE_SHEET_ID }}
                  commands: ${{ steps.prepare_json.outputs.COMMANDS }}
              env:
                  GSHEET_CLIENT_EMAIL: ${{ secrets.GOOGLE_SHEET_CLIENT_EMAIL }}
                  GSHEET_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEET_PRIVATE_KEY }}
