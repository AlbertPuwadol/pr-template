name: Release Drafter

on:
    workflow_call:
        inputs:
            base_branch:
                required: true
                type: string
        secrets:
            PERSONAL_ACCESS_TOKEN:
                required: true
                description: "Personal access token for the repository"
    # push:
    #     branches:
    #         - master
    # # pull_request event is required only for autolabeler
    # pull_request:
    #     # Only following types are handled by the action, but one can default to all as well
    #     types: [opened, reopened, synchronize]
    # # pull_request_target event is required for autolabeler to support PRs from forks
    # # pull_request_target:
    # #     types: [opened, reopened, synchronize]

permissions:
    contents: read

jobs:
    update_release_draft:
        permissions:
            # write permission is required to create a github release
            contents: write
            # write permission is required for autolabeler
            # otherwise, read permission is required at least
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            # (Optional) GitHub Enterprise requires GHE_HOST variable set
            #- name: Set GHE_HOST
            #  run: |
            #    echo "GHE_HOST=${GITHUB_SERVER_URL##https:\/\/}" >> $GITHUB_ENV

            # Drafts your next Release notes as Pull Requests are merged into "master"

            - name: Checkout central template repository
              uses: actions/checkout@v4
              with:
                  repository: "AlbertPuwadol/pr-template" # central repo that holds the template
                  ref: "master" # choose the ref you want
                  path: "pr-template"

            - name: Ensure release-drafter config exists (copy from central template)
              run: |
                  mkdir -p .github
                  if [ -f .github/release-drafter.yml ]; then
                      echo "caller provided config; keeping it"
                  elif [ -f pr-template/.github/release-drafter.yml ]; then
                      echo "copying central template to .github/release-drafter.yml"
                      cp pr-template/.github/release-drafter.yml .github/release-drafter.yml
                  else
                      echo "no template found; will run without config (may fail)"
                  fi

            - uses: release-drafter/release-drafter@v6
              # (Optional) specify config name to use, relative to .github/. Default: release-drafter.yml
              # with:
              #   config-name: my-config.yml
              #   disable-autolabeler: true
              env:
                  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
              with:
                  commitish: ${{ inputs.base_branch }}
